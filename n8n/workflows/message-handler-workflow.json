{
  "name": "Chatwoot Bot - Vitrinnea FINAL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-node-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "chatwoot-messages"
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.item.json;\nconst body = raw.body?.body || raw.body || {};\n\nconst messageType = body.message_type;\nconst senderType = body.sender?.type;\n\nif (messageType === 'outgoing' || (senderType && senderType !== 'contact')) {\n  return [];\n}\n\nconst conversationId = body.conversation?.id;\nconst accountId = body.account?.id;\nconst inboxId = body.inbox?.id || body.conversation?.inbox_id;\n\nif (!conversationId || !accountId) {\n  return [];\n}\n\nconst inboxConfig = {\n  17: {\n    name: 'WhatsApp SV',\n    supportEmail: 'soporte-sv@vitrinnea.com',\n    phone: '+503 2222-2222',\n    helpCenter: 'https://chat-sv.service.vitrinnea.com/hc/servicio-al-cliente'\n  },\n  23: {\n    name: 'WhatsApp',\n    supportEmail: 'soporte@vitrinnea.com',\n    phone: '+506 2222-2222',\n    helpCenter: 'https://chat-sv.service.vitrinnea.com/hc/servicio-al-cliente'\n  },\n  default: {\n    name: 'Chat',\n    supportEmail: 'soporte@vitrinnea.com',\n    phone: '+506 2222-2222',\n    helpCenter: 'https://chat-sv.service.vitrinnea.com/hc/servicio-al-cliente'\n  }\n};\n\nconst inbox = inboxConfig[inboxId] || inboxConfig.default;\nconst message = (body.content || '').toLowerCase().trim();\nconst senderName = body.sender?.name || 'cliente';\n\nconst now = new Date();\nconst hour = now.getHours();\nconst day = now.getDay();\nconst isBusinessHours = (day >= 1 && day <= 5) && (hour >= 9 && hour < 18);\n\nconst urgentWords = ['urgente', 'asap', 'rÃ¡pido', 'ya', 'ahora', 'emergencia'];\nconst negativeWords = ['enojado', 'molesto', 'terrible', 'malo', 'pÃ©simo', 'horrible'];\nconst isUrgent = urgentWords.some(word => message.includes(word));\nconst isNegative = negativeWords.some(word => message.includes(word));\n\nlet intent = 'general';\nlet response = '';\nlet needsHuman = false;\nlet menuOption = null;\n\n// Simplified Menu - Only 3 options\nif (message === '1' || message.includes('ayuda') || message.includes('faq') || message.includes('preguntas') || message.includes('tutorial') || message.includes('como')) {\n  intent = 'help_faq';\n  menuOption = '1';\n  response = `â“ *Preguntas Frecuentes*\\n\\nğŸ“š Centro de Ayuda:\\n${inbox.helpCenter}\\n\\nğŸ“º Tutoriales en YouTube:\\nyoutube.com/@shopvitrinnea\\n\\nğŸ’¬ Â¿Tienes otra pregunta?\\nEscribe MENU o pregÃºntame directamente`;\n  \n} else if (message === '2' || message.includes('contacto') || message.includes('telÃ©fono') || message.includes('email') || message.includes('horario')) {\n  intent = 'contact';\n  menuOption = '2';\n  response = `ğŸ“ *InformaciÃ³n de Contacto*\\n\\nğŸ• Horario: Lun-Vie 9AM-6PM\\n\\nğŸ“§ Email: ${inbox.supportEmail}\\nğŸ“± TelÃ©fono: ${inbox.phone}\\n\\nğŸ’¬ Escribe MENU para mÃ¡s opciones`;\n  \n} else if (message === '3' || message.includes('agente') || message.includes('humano') || message.includes('persona') || message.includes('representante')) {\n  intent = 'request_agent';\n  menuOption = '3';\n  needsHuman = true;\n  response = isBusinessHours\n    ? `ğŸ™‹ Conectando con un agente, ${senderName}...\\n\\nDescribe tu consulta mientras esperas.`\n    : `ğŸ™‹ Entendido, ${senderName}\\n\\nâ° Fuera de horario (Lun-Vie 9AM-6PM)\\nUn agente te contactarÃ¡ maÃ±ana`;\n    \n} else if (message.includes('menu') || message.includes('menÃº') || message.includes('opciones') || message === '0') {\n  intent = 'menu';\n  menuOption = '0';\n  response = `ğŸ“‹ *MenÃº Principal - ${inbox.name}*\\n\\n1ï¸âƒ£ â“ Ayuda y Preguntas Frecuentes\\n2ï¸âƒ£ ğŸ“ InformaciÃ³n de Contacto\\n3ï¸âƒ£ ğŸ™‹ Hablar con un Agente\\n\\nğŸ’¬ O escrÃ­beme tu pregunta directamente`;\n  \n} else if (message.includes('hola') || message.includes('buenos') || message.includes('buenas') || message.includes('hi') || message.includes('hello')) {\n  intent = 'greeting';\n  response = `Â¡Hola ${senderName}! ğŸ‘‹\\n\\nSoy tu asistente virtual de Vitrinnea.\\n\\nğŸ“‹ Escribe *MENU* para ver opciones\\nğŸ’¬ O pregÃºntame lo que necesites`;\n  \n} else if (message.includes('queja') || message.includes('problema') || message.includes('reclamo') || isNegative) {\n  intent = 'complaint';\n  needsHuman = true;\n  response = `ğŸ˜” Lamento que tengas un problema, ${senderName}\\n\\nQuiero ayudarte a resolverlo.\\nCuÃ©ntame quÃ© pasÃ³ y te conecto con un agente.`;\n  \n} else if (message.includes('gracias') || message.includes('thank')) {\n  intent = 'thanks';\n  response = `Â¡De nada, ${senderName}! ğŸ˜Š\\n\\nÂ¿Hay algo mÃ¡s en lo que pueda ayudarte?\\n\\n_Escribe MENU para opciones_`;\n  \n} else {\n  intent = 'general';\n  response = `Hola ${senderName} ğŸ˜Š\\n\\nEstoy aquÃ­ para ayudarte.\\n\\nğŸ“‹ Escribe *MENU* para ver opciones\\nğŸ™‹ O escribe *AGENTE* para hablar con una persona`;\n}\n\nif (isUrgent && isBusinessHours && !needsHuman) {\n  response += '\\n\\nâš¡ Â¿Urgente? Escribe *AGENTE* o *3*';\n}\n\nreturn {\n  conversation_id: conversationId,\n  account_id: accountId,\n  inbox_id: inboxId,\n  inbox_name: inbox.name,\n  sender_name: senderName,\n  original_message: body.content,\n  intent: intent,\n  menu_option: menuOption,\n  response_text: response,\n  is_urgent: isUrgent,\n  is_negative: isNegative,\n  needs_human: needsHuman,\n  business_hours: isBusinessHours,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "code-node-002",
      "name": "Process Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat-sv.service.vitrinnea.com/api/v1/accounts/{{$json.account_id}}/conversations/{{$json.conversation_id}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{$json.response_text}}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": false
            }
          ]
        }
      },
      "id": "http-node-003",
      "name": "Send to Chatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "0A9w8MYKOXlFtIYW",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO engagement_tracking (conversation_id, account_id, inbox_id, inbox_name, sender_name, intent, menu_option, original_message, is_urgent, is_negative, needs_human, business_hours) VALUES ({{ $json.conversation_id }}, {{ $json.account_id }}, {{ $json.inbox_id }}, '{{ $json.inbox_name }}', '{{ $json.sender_name }}', '{{ $json.intent }}', '{{ $json.menu_option }}', '{{ $json.original_message }}', {{ $json.is_urgent }}, {{ $json.is_negative }}, {{ $json.needs_human }}, {{ $json.business_hours }})",
        "options": {}
      },
      "id": "postgres-node-004",
      "name": "Track to PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [900, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-credentials",
          "name": "PostgreSQL account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"ok\"}",
        "options": {}
      },
      "id": "webhook-response-005",
      "name": "Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Process Message", "type": "main", "index": 0}]]
    },
    "Process Message": {
      "main": [[{"node": "Send to Chatwoot", "type": "main", "index": 0}]]
    },
    "Send to Chatwoot": {
      "main": [[
        {"node": "Success", "type": "main", "index": 0},
        {"node": "Track to PostgreSQL", "type": "main", "index": 0}
      ]]
    },
    "Track to PostgreSQL": {
      "main": [[]]
    }
  },
  "active": true,
  "settings": {},
  "id": "vitrinnea-bot-final"
}