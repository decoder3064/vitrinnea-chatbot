{
  "name": "Chatwoot Message Handler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "39e73beb-733f-4fc9-b45c-a0b02e95b330",
      "name": "Webhook - Receive from Chatwoot",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -200,
        0
      ],
      "webhookId": "chatwoot-messages"
    },
    {
      "parameters": {
        "jsCode": "// Vitrinnea webhook structure: data is double-nested in body.body\nconst raw = $input.item.json;\nconst body = raw.body?.body || raw.body || {};\n\n// Check if this is an outgoing message (from bot) - skip those to prevent infinite loop\nconst messageType = body.message_type;\nconst senderType = body.sender?.type;\n\nif (messageType === 'outgoing' || (senderType && senderType !== 'contact')) {\n  return [];\n}\n\n// Extract IDs from body\nconst conversationId = body.conversation?.id;\nconst accountId = body.account?.id;\n\nif (!conversationId || !accountId) {\n  return [];\n}\n\nconst message = (body.content || '').toLowerCase();\nconst senderName = body.sender?.name || 'cliente';\n\n// Business hours (Costa Rica time - assuming UTC-6)\nconst now = new Date();\nconst hour = now.getHours();\nconst day = now.getDay();\nconst isBusinessHours = (day >= 1 && day <= 5) && (hour >= 9 && hour < 18);\n\n// Extract order number if present\nconst orderMatch = message.match(/#?(\\d{4,8})/);\nconst orderNumber = orderMatch ? orderMatch[1] : null;\n\n// Sentiment detection\nconst urgentWords = ['urgente', 'asap', 'rÃ¡pido', 'ya', 'ahora', 'emergencia'];\nconst negativeWords = ['enojado', 'molesto', 'terrible', 'malo', 'pÃ©simo', 'horrible'];\nconst isUrgent = urgentWords.some(word => message.includes(word));\nconst isNegative = negativeWords.some(word => message.includes(word));\n\nlet intent = 'general';\nlet response = '';\n\n// Intent classification with Spanish responses\nif (message.includes('hola') || message.includes('buenos') || message.includes('buenas') || message.includes('hello') || message.includes('hi')) {\n  intent = 'greeting';\n  response = isBusinessHours \n    ? `Â¡Hola ${senderName}! ğŸ‘‹ Bienvenido a Vitrinnea. Â¿En quÃ© puedo ayudarte hoy?`\n    : `Â¡Hola ${senderName}! ğŸ‘‹ Estamos fuera de horario (Lun-Vie 9am-6pm), pero igual puedo ayudarte. Â¿QuÃ© necesitas?`;\n} else if (message.includes('precio') || message.includes('cost') || message.includes('cuÃ¡nto') || message.includes('cuanto')) {\n  intent = 'pricing';\n  response = 'ğŸ’° Con gusto te ayudo con informaciÃ³n de precios. Â¿QuÃ© producto te interesa? Puedes enviarme el nombre o enlace del artÃ­culo.';\n} else if (message.includes('devol') || message.includes('reembolso') || message.includes('cancelar')) {\n  intent = 'returns';\n  response = orderNumber\n    ? `ğŸ“¦ Entendido, revisarÃ© tu pedido #${orderNumber} para procesar la devoluciÃ³n. Nuestras polÃ­ticas permiten devoluciones dentro de 30 dÃ­as. Â¿CuÃ¡l es el motivo?`\n    : 'ğŸ“¦ Puedo ayudarte con devoluciones. Por favor proporcioname tu nÃºmero de orden para revisar tu caso.';\n} else if (message.includes('envio') || message.includes('envÃ­o') || message.includes('entrega') || message.includes('delivery') || message.includes('shipping')) {\n  intent = 'shipping';\n  response = 'ğŸšš Nuestros tiempos de envÃ­o son:\\n\\nâ€¢ EnvÃ­o EstÃ¡ndar: 5-7 dÃ­as hÃ¡biles\\nâ€¢ EnvÃ­o Express: 2-3 dÃ­as hÃ¡biles\\n\\nÂ¿Necesitas rastrear un pedido o tienes alguna pregunta especÃ­fica?';\n} else if (message.includes('pedido') || message.includes('orden') || message.includes('order') || message.includes('rastreo') || message.includes('track')) {\n  intent = 'order_status';\n  response = orderNumber\n    ? `ğŸ” Perfecto, dÃ©jame verificar el estado de tu orden #${orderNumber}. Un momento por favor...`\n    : 'ğŸ” Para revisar tu pedido necesito el nÃºmero de orden. Lo encuentras en tu correo de confirmaciÃ³n (ejemplo: #12345).';\n} else if (message.includes('pago') || message.includes('cobro') || message.includes('tarjeta') || message.includes('factura')) {\n  intent = 'billing';\n  response = 'ğŸ’³ Te ayudo con temas de facturaciÃ³n. Â¿CuÃ¡l es tu consulta especÃ­fica? (problemas de cobro, solicitud de factura, mÃ©todos de pago, etc.)';\n} else if (message.includes('cuenta') || message.includes('perfil') || message.includes('contraseÃ±a') || message.includes('login')) {\n  intent = 'account';\n  response = 'ğŸ‘¤ Para asistencia con tu cuenta, puedo ayudarte con:\\n\\nâ€¢ Recuperar contraseÃ±a\\nâ€¢ Actualizar informaciÃ³n\\nâ€¢ Problemas de acceso\\n\\nÂ¿QuÃ© necesitas?';\n} else if (message.includes('disponib') || message.includes('stock') || message.includes('hay')) {\n  intent = 'availability';\n  response = 'ğŸ“Š Para verificar disponibilidad, necesito saber quÃ© producto te interesa. Â¿Me puedes compartir el nombre o enlace?';\n} else if (message.includes('queja') || message.includes('reclam') || message.includes('problema') || isNegative) {\n  intent = 'complaint';\n  response = `ğŸ˜” Lamento mucho que hayas tenido una mala experiencia, ${senderName}. Tu satisfacciÃ³n es muy importante. Por favor cuÃ©ntame quÃ© sucediÃ³ para resolverlo cuanto antes. ${isBusinessHours ? 'TambiÃ©n puedo transferirte con un supervisor.' : 'Puedes solicitar hablar con un supervisor maÃ±ana en horario laboral.'}`;\n} else if (message.includes('horario') || message.includes('schedule') || message.includes('abierto')) {\n  intent = 'hours';\n  response = 'ğŸ• Nuestro horario de atenciÃ³n es:\\n\\nLunes a Viernes: 9:00 AM - 6:00 PM (Hora Costa Rica)\\nSÃ¡bados y Domingos: Cerrado\\n\\nÂ¿En quÃ© mÃ¡s puedo ayudarte?';\n} else if (message.includes('contacto') || message.includes('telÃ©fono') || message.includes('email') || message.includes('whatsapp')) {\n  intent = 'contact';\n  response = 'ğŸ“ Puedes contactarnos por:\\n\\nâ€¢ Chat (aquÃ­ mismo)\\nâ€¢ Email: soporte@vitrinnea.com\\nâ€¢ WhatsApp: [nÃºmero]\\nâ€¢ TelÃ©fono: [nÃºmero]\\n\\nÂ¿Prefieres algÃºn canal en particular?';\n} else if (message.includes('ayuda') || message.includes('help') || message.includes('soporte') || message.includes('support')) {\n  intent = 'support';\n  response = 'ğŸ†˜ Estoy aquÃ­ para ayudarte. Puedo asistirte con:\\n\\nâ€¢ Estado de pedidos ğŸ“¦\\nâ€¢ EnvÃ­os y entregas ğŸšš\\nâ€¢ Devoluciones y cambios ğŸ”„\\nâ€¢ InformaciÃ³n de productos ğŸ›ï¸\\nâ€¢ FacturaciÃ³n ğŸ’³\\n\\nÂ¿QuÃ© necesitas?';\n} else if (message.includes('gracias') || message.includes('thank')) {\n  intent = 'thanks';\n  response = 'Â¡De nada! ğŸ˜Š Â¿Hay algo mÃ¡s en lo que pueda ayudarte?';\n} else if (message.includes('adios') || message.includes('adiÃ³s') || message.includes('bye') || message.includes('chao')) {\n  intent = 'goodbye';\n  response = 'Â¡Hasta pronto! ğŸ‘‹ Que tengas un excelente dÃ­a. Estamos aquÃ­ cuando nos necesites.';\n} else {\n  intent = 'general';\n  response = `Hola ${senderName}, gracias por escribirnos. Â¿En quÃ© puedo ayudarte hoy? Puedo asistirte con pedidos, envÃ­os, productos, devoluciones y mÃ¡s. ğŸ˜Š`;\n}\n\n// Add urgency flag if detected\nif (isUrgent && isBusinessHours) {\n  response += '\\n\\nâš¡ Veo que es urgente. Si necesitas atenciÃ³n inmediata, puedo transferirte con un agente humano.';\n}\n\nreturn {\n  conversation_id: conversationId,\n  account_id: accountId,\n  sender_name: senderName,\n  original_message: body.content,\n  intent: intent,\n  response_text: response,\n  is_urgent: isUrgent,\n  is_negative: isNegative,\n  order_number: orderNumber\n};"
      },
      "id": "870763de-7a67-45ef-a8e6-821168e81615",
      "name": "Process Message & Generate Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat-sv.service.vitrinnea.com/api/v1/accounts/{{$json[\"account_id\"]}}/conversations/{{$json[\"conversation_id\"]}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.response_text }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": false
            }
          ]
        },
        "options": {}
      },
      "id": "ab05d55d-4515-466b-8682-ddeebbc34697",
      "name": "Send Response to Chatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        200,
        0
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "0A9w8MYKOXlFtIYW",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"success\", \"message\": \"Message processed and response sent\"}",
        "options": {}
      },
      "id": "1a96d78b-e7d9-408a-af16-9be09e572a6b",
      "name": "Respond - Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        400,
        0
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Receive from Chatwoot": {
      "main": [
        [
          {
            "node": "Process Message & Generate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Message & Generate Response": {
      "main": [
        [
          {
            "node": "Send Response to Chatwoot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Response to Chatwoot": {
      "main": [
        [
          {
            "node": "Respond - Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5e64e549-f11f-4308-bf51-b1274ca8d662",
  "meta": {
    "instanceId": "a3b6737e35aa2734674677b22160e82aca50243db3512a23ffddd25f73e78d7d"
  },
  "id": "QI1fj6GtjBeVglht",
  "tags": []
}